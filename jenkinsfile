pipeline {
    agent any

    tools {
        jdk 'jdk21'
        maven 'maven3.8'
    }

    environment {
        SERVER_IP   = '13.61.175.251'
        SSH_CRED_ID = 'jenkins-weather'
        TOMCAT_PATH = '/var/lib/tomcat10/webapps'
        TOMCAT_SVC  = 'tomcat10'
        TOMCAT_USER = 'tomcat10'
    }

    stages {

        stage('Check Environment') {
            steps {
                sh '''
                    echo "===== Checking Environment ====="
                    java -version
                    mvn -version
                    echo "================================"
                '''
            }
        }

        stage('Checkout Code') {
            steps {
                git branch: 'main', url: 'https://github.com/Shivamgarud8/tomcat.git'
            }
        }

        stage('Prepare WebApp Folder') {
            steps {
                sh '''
                    echo "===== Preparing WebApp Structure ====="
                    mkdir -p src/main/webapp
                    cp -r WebContent/* src/main/webapp/ || true
                    echo "Contents of src/main/webapp:"
                    ls -l src/main/webapp/
                    echo "======================================"
                '''
            }
        }

        stage('Build WAR') {
            steps {
                sh '''
                    echo "===== Building WAR File ====="
                    mvn clean package -DskipTests
                    echo "Generated WAR:"
                    ls -lh target/*.war
                    echo "================================"
                '''
            }
        }

        stage('Deploy to Tomcat') {
            steps {
                sshagent([SSH_CRED_ID]) {
                    sh '''
                        echo "===== Copying WAR File ====="
                        WAR_FILE=$(ls target/*.war | head -n 1)
                        echo "WAR File: $WAR_FILE"

                        scp -o StrictHostKeyChecking=no $WAR_FILE ubuntu@${SERVER_IP}:/tmp/app.war

                        ssh -o StrictHostKeyChecking=no ubuntu@${SERVER_IP} << EOF
                            echo ">>> Stopping Tomcat"
                            sudo systemctl stop ${TOMCAT_SVC}

                            echo ">>> Cleaning old deployment"
                            sudo rm -rf ${TOMCAT_PATH}/ROOT ${TOMCAT_PATH}/ROOT.war

                            echo ">>> Deploying new WAR"
                            sudo mv /tmp/app.war ${TOMCAT_PATH}/ROOT.war
                            sudo chown ${TOMCAT_USER}:${TOMCAT_USER} ${TOMCAT_PATH}/ROOT.war

                            echo ">>> Starting Tomcat"
                            sudo systemctl start ${TOMCAT_SVC}

                            echo ">>> Deployment DONE"
                        EOF
                    '''
                }
            }
        }
    }

    post {
        success {
            echo "‚úÖ Deployment successful!"
            echo "üåç Visit: http://${SERVER_IP}:8080/"
        }
        failure {
            echo "‚ùå Deployment failed. Check Jenkins console logs."
        }
    }
}
