pipeline {
    agent any

    tools {
        jdk 'jdk21'
        maven 'maven3.8'
    }

    environment {
        SERVER_IP   = '13.61.175.251'   // TOMCAT SERVER
        SSH_CRED_ID = 'jenkins-weather'
        TOMCAT_SVC  = 'tomcat10'
        TOMCAT_PATH = '/var/lib/tomcat10/webapps'
        TOMCAT_USER = 'tomcat'
    }

    stages {

        stage('Check Build Environment') {
            steps {
                sh '''
                    java -version
                    mvn -version
                '''
            }
        }

        stage('Checkout Code') {
            steps {
                git branch: 'main', url: 'https://github.com/Shivamgarud8/tomcat.git'
            }
        }

        stage('Prepare WebApp') {
            steps {
                sh '''
                    mkdir -p src/main/webapp
                    cp -r WebContent/* src/main/webapp/ || true
                '''
            }
        }

        stage('Build WAR on Jenkins Server') {
            steps {
                sh '''
                    mvn clean package -DskipTests
                    ls -lh target/*.war
                '''
            }
        }

        stage('Auto Install Tomcat & Deploy on REMOTE Server') {
            steps {
                sshagent([SSH_CRED_ID]) {
                    sh """
                        WAR_FILE=\$(ls target/*.war | head -n 1)

                        scp -o StrictHostKeyChecking=no \$WAR_FILE ubuntu@${SERVER_IP}:/tmp/app.war

                        ssh -o StrictHostKeyChecking=no ubuntu@${SERVER_IP} "\
                            set -e && \
                            echo '===== REMOTE TOMCAT SETUP =====' && \
                            if ! systemctl list-unit-files | grep -q ${TOMCAT_SVC}.service; then \
                                sudo apt update && sudo apt install -y ${TOMCAT_SVC}; \
                            fi && \
                            sudo systemctl stop ${TOMCAT_SVC} || true && \
                            sudo rm -rf ${TOMCAT_PATH}/ROOT ${TOMCAT_PATH}/ROOT.war && \
                            sudo mv /tmp/app.war ${TOMCAT_PATH}/ROOT.war && \
                            sudo chown ${TOMCAT_USER}:${TOMCAT_USER} ${TOMCAT_PATH}/ROOT.war && \
                            sudo systemctl start ${TOMCAT_SVC} && \
                            sudo systemctl enable ${TOMCAT_SVC} && \
                            echo '===== DEPLOYMENT COMPLETE =====' \
                        "
                    """
                }
            }
        }

        stage('Health Check') {
            steps {
                sh """
                    sleep 10
                    curl -I http://${SERVER_IP}:8080 || exit 1
                """
            }
        }
    }

    post {
        success {
            echo "‚úÖ ONE-CLICK DEPLOYMENT SUCCESS"
            echo "üåç App URL: http://${SERVER_IP}:8080/"
        }
        failure {
            echo "‚ùå Deployment failed"
        }
    }
}
